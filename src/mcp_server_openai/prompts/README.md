# Enhanced Prompt Manager

A modern, robust prompt management system for MCP Server OpenAI with advanced features, comprehensive error handling, and performance optimization.

## ‚ú® Features

### üöÄ Core Functionality
- **Template-based Prompt Generation**: Uses Jinja2 templates for flexible, maintainable prompts
- **Client-specific Customization**: Per-client overrides for tone, audience, style, and other parameters
- **Configuration Management**: YAML/JSON configuration with environment variable support
- **Backward Compatibility**: Maintains compatibility with existing prompt functions

### üõ°Ô∏è Robustness & Error Handling
- **Comprehensive Validation**: Template validation, parameter validation, and configuration schema validation
- **Graceful Fallbacks**: Multiple fallback strategies when templates or configurations fail
- **Detailed Error Reporting**: Clear error messages with context and recovery suggestions
- **Health Checks**: Built-in health monitoring and diagnostics

### ‚ö° Performance & Caching
- **Advanced Caching**: LRU cache with TTL and intelligent invalidation
- **Async Support**: Non-blocking async operations for high-performance scenarios
- **Metrics Collection**: Performance monitoring with render times, cache hits, and error rates
- **Optimized Rendering**: Efficient template processing and parameter merging

### üé® Advanced Template Features
- **Template Inheritance**: Base templates with child template extensions
- **Macros & Filters**: Reusable template components and custom filters
- **Conditional Rendering**: Dynamic content based on parameters and configuration
- **Custom Filters**: Built-in filters for JSON formatting, URL safety, and more

## üèóÔ∏è Architecture

### Core Classes

#### `PromptManager`
The main class that handles all prompt operations:
- Template loading and caching
- Configuration management
- Parameter merging and validation
- Performance metrics and health monitoring

#### `PromptConfig`
Configuration schema for individual prompts:
- Default values
- Client-specific overrides
- Template paths and cache settings
- Enable/disable flags

#### `RenderResult`
Comprehensive result object containing:
- Rendered content
- Metadata about the render operation
- Performance metrics
- Any errors or warnings

### Configuration Schema

```yaml
prompts:
  summarize:
    defaults:
      tone: "concise"
      audience: "general"
      bullets_min: 4
      bullets_max: 6
      style: "professional"
      language: "en"
    clients:
      acme:
        tone: "detailed"
        audience: "executives"
        bullets_min: 5
        bullets_max: 7
      techcorp:
        style: "technical"
        language: "en"
```

## üìñ Usage

### Basic Usage

```python
from mcp_server_openai.prompts import render, render_async

# Synchronous rendering
prompt = render("summarize", {"topic": "AI Trends"}, client_id="acme")

# Asynchronous rendering
prompt = await render_async("summarize", {"topic": "AI Trends"}, client_id="acme")
```

### Advanced Usage

```python
from mcp_server_openai.prompts import get_prompt_manager

# Get the prompt manager instance
manager = get_prompt_manager()

# Render with full control
result = manager.render(
    "summarize",
    params={"topic": "Machine Learning"},
    client_id="acme",
    validate_params=True
)

# Access performance metrics
metrics = manager.get_metrics("summarize")
print(f"Total renders: {metrics.total_renders}")
print(f"Average render time: {metrics.avg_render_time:.2f}ms")

# Health check
health = manager.health_check()
print(f"Status: {health['status']}")
```

### Template Development

#### Base Template (`base.j2`)
```jinja2
{# Base template with advanced Jinja2 features #}
{%- macro render_bullet_point(text, level=0) -%}
{%- if level > 0 -%}
  {%- for i in range(level) -%}  {%- endfor -%}
{%- endif -%}- {{ text }}
{%- endmacro -%}

{%- block content -%}
{# This will be overridden by child templates #}
{%- endblock -%}

{%- block footer -%}
---
*Generated by MCP Server OpenAI Prompt Manager*
{%- endblock -%}
```

#### Child Template (`summarize.j2`)
```jinja2
{%- extends "base.j2" -%}

{%- block content -%}
# Summary Request

## Topic
{{ topic }}

## Requirements
- **Audience**: {{ audience | default('general') }}
- **Tone**: {{ tone | default('concise') }}
- **Style**: {{ style | default('professional') }}
- **Bullet Points**: {{ bullets_min | default(4) }}‚Äì{{ bullets_max | default(6) }}

## Instructions
Please provide a {{ tone | default('concise') }} summary of the topic "{{ topic }}" for a {{ audience | default('general') }} audience.

### Expected Output
{%- for i in range(bullets_min | default(4), (bullets_max | default(6)) + 1) -%}
- [Bullet point {{ i }}]
{%- endfor -%}
{%- endblock -%}
```

## üîß Configuration

### Environment Variables

```bash
# Enable/disable features
export MCP_PROMPT_DEBUG=true
export MCP_PROMPT_CACHE_SIZE=128
export MCP_PROMPT_CACHE_TTL=300

# Template directory
export MCP_PROMPT_TEMPLATES_DIR=/custom/templates

# Configuration file
export MCP_CONFIG_JSON='{"prompts":{"summarize":{"defaults":{"tone":"concise"}}}}'
```

### Configuration File

```yaml
# config.yaml
prompt_manager:
  templates_dir: "templates"
  cache_size: 128
  cache_ttl: 300
  enable_async: true
  enable_metrics: true
  strict_mode: false
  fallback_templates:
    emergency: "Emergency prompt for {{ topic }}"

prompts:
  summarize:
    defaults:
      tone: "concise"
      audience: "general"
    clients:
      acme:
        tone: "detailed"
        audience: "executives"
```

## üß™ Testing

### Running Tests

```bash
# Run all prompt manager tests
uv run python -m pytest tests/test_prompt_manager.py -v

# Run enhanced prompt manager tests
uv run python -m pytest tests/test_enhanced_prompt_manager.py -v

# Run with coverage
uv run python -m pytest tests/test_enhanced_prompt_manager.py --cov=mcp_server_openai.prompts -v
```

### Test Structure

- **Unit Tests**: Individual component testing
- **Integration Tests**: End-to-end functionality testing
- **Performance Tests**: Cache and rendering performance
- **Error Handling Tests**: Failure scenarios and recovery

## üìä Performance

### Metrics

The prompt manager provides comprehensive performance metrics:

- **Render Times**: Average and per-request render times
- **Cache Performance**: Hit rates and miss patterns
- **Error Rates**: Failure tracking and error categorization
- **Resource Usage**: Memory and CPU utilization

### Optimization Tips

1. **Use Appropriate Cache Sizes**: Balance memory usage with performance
2. **Leverage Template Inheritance**: Reduce duplication and improve maintainability
3. **Optimize Parameter Merging**: Minimize configuration complexity
4. **Monitor Health Checks**: Regular health monitoring for proactive maintenance

## üîÑ Migration Guide

### From Legacy Prompt Manager

The enhanced prompt manager maintains full backward compatibility:

```python
# Old way (still works)
from mcp_server_openai.prompts.summarize import summarize
prompt = summarize("AI Trends", tone="detailed")

# New way (recommended)
from mcp_server_openai.prompts import render
prompt = render("summarize", {"topic": "AI Trends", "tone": "detailed"})
```

### Breaking Changes

- None - all existing code continues to work
- New features are opt-in and don't affect existing functionality

## üöÄ Future Enhancements

### Planned Features

- **Template Versioning**: Version control for templates
- **A/B Testing**: Template performance comparison
- **Advanced Caching**: Redis-based distributed caching
- **Template Marketplace**: Community template sharing
- **AI-Powered Optimization**: Automatic template improvement suggestions

### Contributing

We welcome contributions! Please see our contributing guidelines for:

- Code style and standards
- Testing requirements
- Documentation updates
- Feature proposals

## üìö API Reference

### Core Functions

- `render(prompt_name, params, client_id)`: Render a prompt synchronously
- `render_async(prompt_name, params, client_id)`: Render a prompt asynchronously
- `get_prompt_manager()`: Get the global prompt manager instance
- `clear_global_prompt_manager()`: Clear the global instance cache
- `reload_global_prompt_manager()`: Reload the global instance

### Classes

- `PromptManager`: Main prompt management class
- `PromptConfig`: Configuration schema class
- `PromptDefaults`: Default values schema
- `ClientOverrides`: Client-specific overrides schema
- `RenderResult`: Render operation result
- `PromptMetrics`: Performance metrics

### Error Classes

- `PromptManagerError`: Base exception class
- `TemplateNotFoundError`: Template not found
- `TemplateRenderError`: Template rendering failed
- `ConfigurationError`: Configuration validation failed

## üìÑ License

This enhanced prompt manager is part of the MCP Server OpenAI project and is licensed under the MIT License.

## ü§ù Support

For support and questions:

- **Issues**: GitHub issue tracker
- **Discussions**: GitHub discussions
- **Documentation**: This README and inline code documentation
- **Examples**: Test files and sample configurations
